<!doctype html>
<!--
  Страница «Активные диалоги»
  Архитектура / примечания рефакторинга:
    - Все кастомные цвета — только через CSS переменные (см. styles.css).
    - Добавлен SVG sprite для повторяющейся галочки select.
    - Улучшены мета-теги и доступность: skip link, role="log" для чата.
    - JS селекторы (id/class) сохранены без изменений для полной обратной совместимости.
-->
<html lang="ru" class="no-js">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Интерфейс оператора поддержки: активные диалоги, просмотр сообщений и шаблоны ответов." />
  <meta name="theme-color" content="#11141b" />
  <meta name="color-scheme" content="dark light" />
  <title>Активные диалоги — Чат поддержки</title>
  <link rel="stylesheet" href="styles.css" />
  <script>document.documentElement.classList.remove('no-js');</script>
  <!-- SVG SPRITE (inline) -->
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true" focusable="false">
    <symbol id="icon-check" viewBox="0 0 18 18">
      <path d="M5 9.5l3 3 5-5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
  </svg>
</head>
<body>
  <a class="visually-hidden" href="#mainContent">Перейти к основному содержимому</a>
  <!-- LOGIN SCREEN (overlay) -->
  <div id="loginScreen" class="login-screen" aria-hidden="true" hidden>
    <form id="loginForm" class="login-card" novalidate autocomplete="on">
      <h1 class="login-card__title">Вход</h1>
      <p class="login-card__subtitle">Войдите в свой аккаунт</p>
      <div class="login-card__field-group">
        <label class="login-card__label" for="loginUsername">Логин</label>
        <input id="loginUsername" name="username" class="login-card__input" type="text" placeholder="Ваш логин" required autocomplete="username" />
        <div class="login-card__error" data-error-for="loginUsername"></div>
      </div>
      <div class="login-card__field-group">
        <label class="login-card__label" for="loginPassword">Пароль</label>
        <input id="loginPassword" name="password" class="login-card__input" type="password" placeholder="••••••••" required autocomplete="current-password" />
        <div class="login-card__error" data-error-for="loginPassword"></div>
      </div>
      <div class="login-card__actions">
        <button type="submit" class="login-card__btn" id="loginSubmit">
          <span class="btn__spinner" aria-hidden="true" hidden></span>
          <span class="login-card__btn-label">Войти</span>
        </button>
      </div>
      <div class="login-card__global-error" id="loginGlobalError" role="alert" hidden></div>
    </form>
  </div>
  <div class="shell">
    <!-- ХЕДЕР -->
    <header class="app-header">
      <div class="app-header__left">
        <span class="app-header__icon" aria-hidden="true">
          <img src="images/headphones.svg" alt="Наушники" />
        </span>
        <span class="app-header__title">Активные диалоги</span>
        <span class="sidebar__counter" id="totalCounter">0</span>
      </div>
      <div class="app-header__right">
        <button class="btn text-danger" id="btnLogout" type="button" title="Выйти" aria-label="Выйти">
          <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" x2="9" y1="12" y2="12" />
          </svg>
        </button>
      </div>
    </header>

    <!-- ОСНОВНОЙ ЛЕЙАУТ: САЙДБАР + РАБОЧАЯ ОБЛАСТЬ -->
  <div class="app" id="mainContent">
      <!-- ЛЕВАЯ КОЛОНКА -->
      <aside class="sidebar" aria-label="Список диалогов">
        <!-- В САЙДБАРЕ — ТОЛЬКО СТРОКА ПРОЕКТА -->
        <div class="sidebar__project">
          <label class="sidebar__label" for="projectSelect">Проект:</label>

          <div class="select" aria-expanded="false">
            <select id="projectSelect" class="select__native" aria-label="Выбор проекта">
              <option selected>АвтоЭксперт RU</option>
              <option>АвтоЭксперт UA</option>
              <option>Top Drive</option>
            </select>
            <span class="select__display" id="projectDisplay" role="button" aria-haspopup="listbox">АвтоЭксперт RU</span>
            <span class="select__arrow text-muted" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <div class="select__dropdown" id="projectDropdown" role="listbox" aria-labelledby="projectDisplay">
              <div class="select__option select__option--selected" data-value="АвтоЭксперт RU" tabindex="0" aria-selected="true">
                <span class="select__check" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><use href="#icon-check"/></svg>
                </span>
                АвтоЭксперт RU
              </div>
              <div class="select__option" data-value="АвтоЭксперт UA" tabindex="0" aria-selected="false">
                <span class="select__check" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><use href="#icon-check"/></svg>
                </span>
                АвтоЭксперт UA
              </div>
              <div class="select__option" data-value="Top Drive" tabindex="0" aria-selected="false">
                <span class="select__check" aria-hidden="true">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><use href="#icon-check"/></svg>
                </span>
                Top Drive
              </div>
            </div>
          </div>

          <button class="icon-btn text-muted" id="projectMenuBtn" title="Дополнительно" aria-haspopup="menu" aria-expanded="false" aria-controls="projectMenu" aria-label="Дополнительно">
            <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/>
            </svg>
          </button>
          <div class="popup-menu" id="projectMenu" role="menu" aria-hidden="true">
            <button class="popup-menu__item" role="menuitem" id="menuEditKb">
              <img class="popup-menu__icon" src="images/database.svg" alt="" aria-hidden="true" />
              <span class="popup-menu__label">Изменить базу знаний</span>
            </button>
            <button class="popup-menu__item" role="menuitem" id="menuOpenArchive">
              <img class="popup-menu__icon" src="images/archive.svg" alt="" aria-hidden="true" />
              <span class="popup-menu__label">Открыть архивные чаты</span>
            </button>
          </div>
        </div>

  <ul class="dialog-list" id="dialogList" role="listbox" aria-label="Активные диалоги" tabindex="0">
          <!-- Элементы списка рендерятся JS -->
        </ul>

        <footer class="sidebar__footer">
          <button class="btn btn--ghost text-muted" id="btnPrev" type="button">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
            <span>Назад</span>
          </button>

          <div class="pager">
            <span id="pageInfo">1 из 1</span>
          </div>

          <button class="btn btn--ghost text-muted" id="btnNext" type="button">
            <span>Вперёд</span>
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"/>
            </svg>
          </button>
        </footer>
      </aside>

      <!-- ПРАВАЯ ОБЛАСТЬ -->
      <main class="workspace" aria-live="polite" aria-busy="false">
        <div class="workspace__empty">
          <h2 class="workspace__title">Выберите диалог</h2>
          <p class="workspace__hint">
            Выберите диалог из списка слева для просмотра переписки
          </p>
        </div>

        <!-- Правый блок чата: отображается только когда выбран диалог -->
  <div class="chat" id="chatPanel" hidden>
          <!-- Шапка чата -->
          <header class="chat__header" id="chatHeader">
            <div class="chat__header-left">
              <h2 class="chat__user" id="chatUser">user_XXX</h2>
              <div class="chat__meta" id="chatMeta"><!-- meta заполняется JS: платформа • версия • UID --></div>
            </div>
            <div class="chat__header-right">
              <span class="badge" id="chatBadge" aria-hidden="false">Нейросеть</span>
            </div>
          </header>

          <!-- Тело чата (сообщения) -->
            <div class="chat__body" id="chatBody" role="log" aria-live="polite" aria-relevant="additions" aria-atomic="false">
              <!-- Сообщения чата рендерятся динамически JS (MessageStore) -->
            </div>

          <!-- Нижняя область (футер) -->
          <footer class="chat__footer" id="chatFooter">
            <!-- Динамически наполняется JS: баннер ИИ или плейсхолдер оператора -->
          </footer>
        </div>
      </main>
    </div>
  </div>

  <!-- MODAL: Templates -->
  <div class="templates-modal" id="templatesModal" aria-hidden="true" role="dialog" aria-labelledby="templatesModalTitle" aria-modal="true">
    <div class="templates-modal__dialog">
      <header class="templates-modal__header">
        <h2 class="templates-modal__title" id="templatesModalTitle">
          <img src="images/templates.svg" alt="" class="templates-modal__title-icon" aria-hidden="true" />
          Шаблоны ответов
        </h2>
        <button class="templates-modal__close" id="templatesModalClose" type="button" aria-label="Закрыть модальное окно">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </header>

      <div class="templates-modal__tabs">
        <div class="templates-modal__tabs-container" role="tablist" aria-label="Вкладки шаблонов">
          <button class="templates-modal__tab" id="templatesTab" role="tab" 
                  aria-selected="true" aria-controls="templatesPanel" tabindex="0">
            <svg class="templates-modal__tab-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" />
              <path d="M14 2v4a2 2 0 0 0 2 2h4" />
              <path d="M10 9H8" />
              <path d="M16 13H8" />
              <path d="M16 17H8" />
            </svg>
            <span class="templates-modal__tab-label">Шаблоны (<span id="templatesCount" aria-live="polite" aria-atomic="true">5</span>)</span>
          </button>
          <button class="templates-modal__tab" id="createTab" role="tab" 
                  aria-selected="false" aria-controls="createPanel" tabindex="-1">
            <svg class="templates-modal__tab-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="templates-modal__tab-label">Создать</span>
          </button>
        </div>
      </div>

      <div class="templates-modal__content">
        <!-- Tab 1: Templates List -->
        <div class="templates-modal__tab-panel" id="templatesPanel" role="tabpanel" 
             aria-labelledby="templatesTab" aria-hidden="false">
          <div class="templates-list" id="templatesList">
            <!-- Templates will be rendered here by JS -->
          </div>
          <div class="templates-empty" id="templatesEmpty" hidden>
            <h3 class="templates-empty__title">Нет шаблонов</h3>
            <p class="templates-empty__subtitle">Создайте первый шаблон во вкладке «Создать»</p>
          </div>
        </div>

        <!-- Tab 2: Create Template -->
        <div class="templates-modal__tab-panel" id="createPanel" role="tabpanel" 
             aria-labelledby="createTab" aria-hidden="true">
          <form class="template-form" id="templateForm">
            <div class="template-form__field">
              <label class="template-form__label" for="templateName">Название шаблона</label>
              <input class="template-form__input" type="text" id="templateName" 
                     placeholder="Например: Приветствие" maxlength="100" required />
            </div>
            
            <div class="template-form__field">
              <label class="template-form__label" for="templateText">Текст шаблона</label>
              <textarea class="template-form__textarea" id="templateText" 
                        placeholder="Введите текст шаблона..." required></textarea>
            </div>

            <div class="template-form__actions">
              <button type="submit" class="template-form__btn template-form__btn--primary" id="templateSave">
                <img src="images/add.svg" alt="" class="template-form__btn-icon" aria-hidden="true" />
                <span>Создать шаблон</span>
              </button>
              <button type="button" class="template-form__btn template-form__btn--secondary" id="templateCancel">
                Отмена
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="templates-modal__shortcuts" aria-label="Горячие клавиши шаблонов">
        <div class="templates-modal__shortcut-item">
          <kbd class="templates-modal__kbd">Escape</kbd>
          <span class="templates-modal__shortcut-label">— закрыть окно</span>
        </div>
      </div>
    </div>
  </div>

  <script src="scripts.js" defer></script>
  
  <!-- MODAL: Unsubscribe Confirmation -->
  <div class="confirm-modal" id="unsubscribeModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="unsubscribeTitle">
    <div class="confirm-modal__dialog" role="document">
      <header class="confirm-modal__header">
        <!-- Warning triangular icon (accent) -->
        <svg class="confirm-modal__icon-svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--warning-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z" />
          <path d="M12 9v5" />
          <path d="M12 17h.01" />
        </svg>
        <h2 class="confirm-modal__title" id="unsubscribeTitle">Отменить подписку</h2>
        <button class="confirm-modal__close" id="unsubscribeClose" type="button" aria-label="Закрыть окно">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </header>
      <div class="confirm-modal__body">
        <p class="confirm-modal__text">Вы уверены, что хотите отменить подписку для пользователя <span class="confirm-modal__user" id="unsubscribeUserName">user_X</span>?</p>
        <p class="confirm-modal__note">Это действие нельзя будет отменить.</p>
        <div class="confirm-modal__error" id="unsubscribeError" role="alert" hidden>
          <div class="confirm-modal__error-icon" aria-hidden="true">
            <svg class="confirm-modal__error-icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--danger-bright)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z" />
              <path d="M12 9v5" />
              <path d="M12 17h.01" />
            </svg>
          </div>
          <div class="confirm-modal__error-text" id="unsubscribeErrorText">Не удалось найти и отменить подписку</div>
        </div>
      </div>
      <footer class="confirm-modal__footer">
        <button type="button" class="confirm-modal__btn" id="unsubscribeCancel">Отмена</button>
        <button type="button" class="confirm-modal__btn confirm-modal__btn--danger" id="unsubscribeConfirm">
          <span class="btn__spinner" aria-hidden="true" hidden></span>
          <span class="confirm-modal__btn-label">Отменить подписку</span>
        </button>
      </footer>
    </div>
  </div>

  <!-- MODAL: Logout Confirmation -->
  <div class="confirm-modal confirm-modal--sm" id="logoutModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
    <div class="confirm-modal__dialog" role="document">
      <header class="confirm-modal__header">
        <svg class="confirm-modal__icon-svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" x2="9" y1="12" y2="12" />
        </svg>
        <h2 class="confirm-modal__title" id="logoutTitle">Подтверждение выхода</h2>
        <button class="confirm-modal__close" id="logoutClose" type="button" aria-label="Закрыть окно">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </header>
      <div class="confirm-modal__body">
        <p class="confirm-modal__text">Вы действительно хотите выйти из аккаунта?</p>
        <p class="confirm-modal__note">После выхода потребуется повторный вход для продолжения работы.</p>
      </div>
      <footer class="confirm-modal__footer">
        <button type="button" class="confirm-modal__btn" id="logoutCancel">Отмена</button>
        <button type="button" class="confirm-modal__btn confirm-modal__btn--danger" id="logoutConfirm">
          <span class="btn__spinner" aria-hidden="true" hidden></span>
          <span class="confirm-modal__btn-label">Выйти</span>
        </button>
      </footer>
    </div>
  </div>
</body>
</html>